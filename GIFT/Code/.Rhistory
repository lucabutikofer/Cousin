legend.title = element_text(size = 7),
legend.key.size = unit(4, 'mm'),
legend.position = "bottom",
legend.box.spacing = unit(1, "cm"),
plot.margin = unit(c(1,1,1,1),"cm"))
ggsave(phy_plot,
filename = "CRW_Tree_All.png",
path = od,
# bg = "white",
width = 40,
height = 40,
units = "cm",
dpi = 300)
phy_gen
phy_gen$edge
phy_gen$edge %>% class
phy_gen$edge %>% dim
phy_gen %>% class
phy %>% class
tax
GIFT_taxonomy(GIFT_version = "beta")
?GIFT_taxonomy
phy %>% class
#==============#
# Libraries ####
#==============#
library(GIFT)
library(fuzzyjoin)
library(data.table)
library(dplyr)
library(magrittr)
od <- # output directory
"../Outputs/GIFT_Harmonised_Names" %T>%
dir.create(recursive = T, showWarnings = F)
# #==========================================#
# # Retrieve CWR harmonised species names ####
# #==========================================#
#
# gsp <- function(x){ # function to retain only genus and species
#   strsplit(x, " ") %>% first %>% `[`(1:2) %>% paste(collapse = " ")
# }
#
# cwrl <- # crop wild relatives list
#   read.csv("../Inputs/20240226_EuropeanCWRchecklist.csv") %>%
#   tibble %>%
#   mutate(taxon = sapply(FullAcceptedName, gsp))
#
# sp_list <- cwrl$taxon %>% `names<-`(NULL) %>% unique
# gift_sp <- GIFT_species() %>% tibble
#
# # # Hard matches
# # foo <- sapply(sp_list, function(x) grep(x, gift_sp$work_species)) %>% unlist
# # bar <- gift_sp[as.numeric(foo),] %>% distinct
#
# # With fuzzy matching with fuzzyjoin package
# sp_list <- tibble(work_species = sp_list)
#
# system.time({
#   fuzz_cwr <-
#     stringdist_join(sp_list, gift_sp,
#                     by = "work_species",
#                     mode = "left",
#                     ignore_case = FALSE,
#                     method = "jw",
#                     max_dist = 99,
#                     distance_col = "dist")
# }) # 24 min.
#
# cwr_hnms <- # CWR harmonised names
#   fuzz_cwr %>%
#   group_by(work_species.x) %>%
#   slice_min(order_by = dist, n = 1)
#
# write_fst(fuzz_cwr, file.path(od, "CWR_GIFT_fuzzy_matches.fst"))
# write_fst(cwr_hnms, file.path(od, "CWR_GIFT_fuzzy_Spp_List.fst"))
#============================================#
# Retrieve crops harmonised species names ####
#============================================#
crps_raw <- # crops list
"../../Crops/FAO/Crop List_PlantTreaty_2022_9_5.csv" %>%
read.csv %>%
tibble %>%
select(Common.name...main, Taxa) %>%
rename(Common_name = Common.name...main) %>%
na.omit
crps <- # crops list
crps_raw %>%
pull(Taxa) %>%
sapply(. %>% strsplit(", ") %>% first) %>%
unlist %>%
`names<-`(NULL) %>%
unique
crps_name <-
lapply(seq_along(crps), function(n){
crps_raw %>%
slice(grep(crps[n], crps_raw$Taxa)[1]) %>%
pull(Common_name)
}) %>%
unlist
gift_sp <- GIFT_species(GIFT_version = "3.1") %>% tibble
sp_list <- tibble(work_species = crps,
common_name = crps_name)
system.time({
fuzz_crop <-
stringdist_join(sp_list, gift_sp,
by = "work_species",
mode = "left",
ignore_case = FALSE,
method = "jw",
max_dist = 99,
distance_col = "dist")
}) # 21 min.
crop_hrms <- # CWR harmonised names
fuzz_crop %>%
group_by(work_species.x) %>%
slice_min(order_by = dist, n = 1) %>%
rename(harmonised_name = work_species.y) %>%
select(-work_species.x)
crop_hrms
fwrite(fuzz_crop, file.path(od, "Crops_GIFT_fuzzy_matches.csv"), nThread = 8)
fwrite(crop_hrms, file.path(od, "Crops_GIFT_fuzzy_Spp_List.csv"), nThread = 8)
# fwrite(fuzz_crop, file.path(od, "Crops_GIFT_fuzzy_matches.csv"), nThread = 8)
fwrite(crop_hrms, file.path(od, "Crops_GIFT_fuzzy_Spp_List.csv"), nThread = 8)
rm(list=ls())
gc()
#==============#
# Libraries ####
#==============#
library(GIFT)
library(data.table)
library(fst)
library(ape)           # pylogenetic tree operations
library(ggplot2)
library(BiocManager)   # needed to run the following packages?
library(ggtree)        # plotting phylogenetic trees
library(tidytree)      # plotting phylogenetic trees
library(ggtreeExtra)   # plotting phylogenetic trees
library(ape)           # pairwise distances from a phylogenetic tree
library(dplyr)
library(magrittr)
od <- # output directory
"../Outputs/GIFT_Phylogeny" %T>%
dir.create(recursive = T, showWarnings = F)
# Download phylogeny ####
phy <- # phylogeny of vascular plants
GIFT_phylogeny(clade = "Tracheophyta",
GIFT_version = "3.1")
# Problem with hybrid species on the tip labels of the phylo tree
phy$tip.label[substring(phy$tip.label, 1, 2) == "x_"] <-
substring(phy$tip.label[substring(phy$tip.label, 1, 2) == "x_"],
3,
nchar(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"]))
phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"] <-
substring(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"],
3,
nchar(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"]))
# Load crops and CWRs ####
cwr <- # crop wild relatives
read.fst("../Outputs/GIFT_Harmonised_Names/CWR_GIFT_fuzzy_Spp_List.fst") %>%
tibble
crops <- # crop species
fread("../Outputs/GIFT_Harmonised_Names/Crops_GIFT_fuzzy_Spp_List.csv") %>%
tibble
conflict <- # species listed both as crops and CWRs
cwr[cwr$work_ID %in% crops$work_ID,] %>%
arrange(work_ID) %>%
select(work_species.y,
work_genus,
work_author,
work_ID) %>%
rename(work_species = work_species.y) %T>%
fwrite(file.path(od, "Spp_both_crop_and_CWR.csv"))
# crops %<>% # remove species listed as CWR from the crop list
#   filter(!(work_ID %in% conflict$work_ID))
cwr %<>% # remove species listed as crops from the CWR list
filter(!(work_ID %in% conflict$work_ID))
sp <- # list of species of interest
bind_rows(cwr, crops) %>%
select(work_species.y,
work_genus,
work_ID) %>%
rename(work_species = work_species.y) %>%
mutate(is_crop = c(rep(F, nrow(cwr)), rep(T, nrow(crops)))) %>%
filter(!duplicated(.[["work_ID"]])) # remove duplicates (same work_ID)
# ! takes some time ! #
sp_fam <- # family of each species
GIFT_taxgroup(work_ID = sp$work_ID,
taxon_lvl = "family",
GIFT_version = "3.1")
sp_genus_fam <- # add family
sp %>%
mutate(family = sp_fam) %>%
mutate(species = gsub("([[:punct:]])|\\s+",
"_",
work_species))
sp_phy <- # species with philogeny
sp_genus_fam %>%
filter(species %in% phy$tip.label)
crops
# Nearest crops ####
dm <- # distance matrix
cophenetic(phy_gen)
phy_gen <- # keep only crops and CWRs
ape::keep.tip(phy = phy, # ape:: is needed as same function in tidytree{}
tip = phy$tip.label[phy$tip.label %in% sp_phy$species])
is_crop <- # labels to colour tree fruits
left_join(tibble(species = phy_gen$tip.label),
sp_phy,
by = "species") %>%
pull(is_crop)
dm <- # distance matrix
cophenetic(phy_gen)
cr_phy <- # crops from phylogeny
sp_phy %>%
filter(is_crop == T) %>%
pull(species)
cwr_phy <- # CWRs from phylogeny
sp_phy %>%
filter(is_crop == F) %>%
pull(species)
nc <- # nearest crop
sapply(seq_along(cwr_phy), function(n){
cr_candidates <- # crop candidates
dm[cwr_phy[n], cr_phy]
crop_dist <- # genetic distance
cr_candidates %>%
min
crop_names <- # crop names (there may be multiple equidistant crops)
cr_candidates[cr_candidates == crop_dist] %>%
names
return(sort(crop_names[1])) # return first in alfabetical order
})
fc <- # foreign crops
cr_phy[!(cr_phy %in% nc)]
sp_phy2 <-
sp_phy %>%
filter(!(species %in% fc))
# > Plot ####
phy_gen2 <- # keep only crops and CWRs
ape::keep.tip(phy = phy, # ape:: is needed as same function in tidytree{}
tip = phy$tip.label[phy$tip.label %in% sp_phy2$species])
is_crop2 <- # labels to colour tree fruits
left_join(tibble(species = phy_gen2$tip.label),
sp_phy2,
by = "species") %>%
pull(is_crop)
phy_plot2 <- # phylogenetic plot
ggtree(phy_gen2,
layout = "circular",
color = "grey")  %<+%
data.frame(is_crop2) +
geom_fruit(geom = geom_tile,
mapping = aes(fill = is_crop2),
width = 3,
offset = 0.01) +
geom_tiplab(size = 1.25,
offset = 4) +
theme(legend.text = element_text(size = 5),
legend.title = element_text(size = 7),
legend.key.size = unit(4, 'mm'),
legend.position = "bottom",
legend.box.spacing = unit(1, "cm"),
plot.margin = unit(c(1,1,1,1),"cm"))
phy_plot2
crops
sp
sp %>% tail
rm(list=ls())
library(GIFT)
library(data.table)
library(fst)
library(ape)           # pylogenetic tree operations
library(ggplot2)
library(BiocManager)   # needed to run the following packages?
library(ggtree)        # plotting phylogenetic trees
library(tidytree)      # plotting phylogenetic trees
library(ggtreeExtra)   # plotting phylogenetic trees
library(ape)           # pairwise distances from a phylogenetic tree
library(dplyr)
library(magrittr)
od <- # output directory
"../Outputs/GIFT_Phylogeny" %T>%
dir.create(recursive = T, showWarnings = F)
phy <- # phylogeny of vascular plants
GIFT_phylogeny(clade = "Tracheophyta",
GIFT_version = "3.1")
# Problem with hybrid species on the tip labels of the phylo tree
phy$tip.label[substring(phy$tip.label, 1, 2) == "x_"] <-
substring(phy$tip.label[substring(phy$tip.label, 1, 2) == "x_"],
3,
nchar(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"]))
phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"] <-
substring(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"],
3,
nchar(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"]))
cwr <- # crop wild relatives
read.fst("../Outputs/GIFT_Harmonised_Names/CWR_GIFT_fuzzy_Spp_List.fst") %>%
tibble
cwr
cwr %>% tail
crops <- # crop species
fread("../Outputs/GIFT_Harmonised_Names/Crops_GIFT_fuzzy_Spp_List.csv") %>%
tibble
crops
conflict <- # species listed both as crops and CWRs
cwr[cwr$work_ID %in% crops$work_ID,] %>%
arrange(work_ID) %>%
select(work_species.y,
work_genus,
work_author,
work_ID) %>%
rename(work_species = work_species.y) %T>%
fwrite(file.path(od, "Spp_both_crop_and_CWR.csv"))
conflict
cwr %<>% # remove species listed as crops from the CWR list
filter(!(work_ID %in% conflict$work_ID))
cwr
cwr %>% tail
bind_rows(cwr, crops)
names(cwr)
View(cwr)
crops
names(crops)
cwr_sel <-
select(cwr, work_species.y, work_genus, work_ID) %>%
rename(work_species = work_species.y)
crps_sel <-
select(crops, harmonised_name, work_genus, work_ID) %>%
rename(work_species = harmonised_name)
cwr_sel
crps_sel
sp <- # list of species of interest
bind_rows(cwr_sel,
crps_sel) %>%
mutate(is_crop = c(rep(F, nrow(cwr)), rep(T, nrow(crops)))) %>%
filter(!duplicated(.[["work_ID"]])) # remove duplicates (same work_ID)
sp
# ! takes some time ! #
sp_fam <- # family of each species
GIFT_taxgroup(work_ID = sp$work_ID,
taxon_lvl = "family",
GIFT_version = "3.1")
sp_fam
sp_fam %>% length()
nrow(sp)
sp_genus_fam <- # add family
sp %>%
mutate(family = sp_fam) %>%
mutate(species = gsub("([[:punct:]])|\\s+",
"_",
work_species))
sp_genus_fam
sp_phy <- # species with philogeny
sp_genus_fam %>%
filter(species %in% phy$tip.label)
phy_gen <- # keep only crops and CWRs
ape::keep.tip(phy = phy, # ape:: is needed as same function in tidytree{}
tip = phy$tip.label[phy$tip.label %in% sp_phy$species])
is_crop <- # labels to colour tree fruits
left_join(tibble(species = phy_gen$tip.label),
sp_phy,
by = "species") %>%
pull(is_crop)
phy_plot <- # phylogenetic plot
ggtree(phy_gen,
layout = "circular",
color = "grey")  %<+%
data.frame(is_crop) +
geom_fruit(geom = geom_tile,
mapping = aes(fill = is_crop),
width = 3,
offset = 0.01) +
geom_tiplab(size = 1.25,
offset = 4) +
theme(legend.text = element_text(size = 5),
legend.title = element_text(size = 7),
legend.key.size = unit(4, 'mm'),
legend.position = "bottom",
legend.box.spacing = unit(1, "cm"),
plot.margin = unit(c(1,1,1,1),"cm"))
phy_plot
dm <- # distance matrix
cophenetic(phy_gen)
cr_phy <- # crops from phylogeny
sp_phy %>%
filter(is_crop == T) %>%
pull(species)
cwr_phy <- # CWRs from phylogeny
sp_phy %>%
filter(is_crop == F) %>%
pull(species)
nc <- # nearest crop
sapply(seq_along(cwr_phy), function(n){
cr_candidates <- # crop candidates
dm[cwr_phy[n], cr_phy]
crop_dist <- # genetic distance
cr_candidates %>%
min
crop_names <- # crop names (there may be multiple equidistant crops)
cr_candidates[cr_candidates == crop_dist] %>%
names
return(sort(crop_names[1])) # return first in alfabetical order
})
fc <- # foreign crops
cr_phy[!(cr_phy %in% nc)]
sp_phy2 <-
sp_phy %>%
filter(!(species %in% fc))
phy_gen2 <- # keep only crops and CWRs
ape::keep.tip(phy = phy, # ape:: is needed as same function in tidytree{}
tip = phy$tip.label[phy$tip.label %in% sp_phy2$species])
is_crop2 <- # labels to colour tree fruits
left_join(tibble(species = phy_gen2$tip.label),
sp_phy2,
by = "species") %>%
pull(is_crop)
phy_plot2 <- # phylogenetic plot
ggtree(phy_gen2,
layout = "circular",
color = "grey")  %<+%
data.frame(is_crop2) +
geom_fruit(geom = geom_tile,
mapping = aes(fill = is_crop2),
width = 3,
offset = 0.01) +
geom_tiplab(size = 1.25,
offset = 4) +
theme(legend.text = element_text(size = 5),
legend.title = element_text(size = 7),
legend.key.size = unit(4, 'mm'),
legend.position = "bottom",
legend.box.spacing = unit(1, "cm"),
plot.margin = unit(c(1,1,1,1),"cm"))
phy_plot2
ggsave(phy_plot2,
filename = "CRW_Tree_Next_Of_Keen.png",
path = od,
width = 40,
height = 40,
units = "cm",
dpi = 300)
sp_phy2
sp_phy2 <-
sp_phy %>%
filter(!(species %in% fc)) %>%
mutate(nearest_crop = nc)
cwr_phy
nc
cwr_phy
cwr_crop <- # nearest crop to each CWR
tibble(cwr = cwr_phy,
crop = nc)
cwr_crop
crops
crops <- # crop species
fread("../Outputs/GIFT_Harmonised_Names/Crops_GIFT_fuzzy_Spp_List.csv") %>%
tibble %>%
mutate(species = gsub("([[:punct:]])|\\s+",
"_",
harmonised_name))
crops
?left_join
left_join(cwr_crop, crops, by = join_by(crops == species))
cwr_crop
left_join(cwr_crop, crops, by = join_by(crop == species))
cwr_crop
crops
crops
View(crops)
left_join(cwr_crop, crops, by = join_by(crop == species))
View(cwr_crop)
View(crops)
cwr_crop
cwr_crop
cwr_crop
crops
crops
crops %>%
filter(!duplicated(.[["harmonised_name"]])) %>% # remove duplicates (same work_ID)
mutate(species = gsub("([[:punct:]])|\\s+",
"_",
harmonised_name)) %>%
left_join(cwr_crop, ., by = join_by(crop == species))
cwr_crop
cwr_crop$crop_common_name <-
crops %>%
filter(!duplicated(.[["harmonised_name"]])) %>% # remove duplicates (same work_ID)
mutate(species = gsub("([[:punct:]])|\\s+",
"_",
harmonised_name)) %>%
left_join(cwr_crop, ., by = join_by(crop == species))
cwr_crop
cwr_crop <- # nearest crop to each CWR
tibble(cwr = cwr_phy,
crop = nc)
crops
cwr_crop$crop_common_name <- # add crop's common name
crops %>%
filter(!duplicated(.[["harmonised_name"]])) %>% # remove duplicates (same work_ID)
mutate(species = gsub("([[:punct:]])|\\s+",
"_",
harmonised_name)) %>%
left_join(cwr_crop, ., by = join_by(crop == species)) %>%
pull(common_name)
cwr_crop
is_crop2
is_crop2 %>% length()
phy_gen2
cwr_crop
cwr_phy
cr_phy
nc
