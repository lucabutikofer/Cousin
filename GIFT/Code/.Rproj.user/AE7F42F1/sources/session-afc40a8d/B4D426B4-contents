
#==============#
# Libraries ####
#==============#

library(GIFT)
library(data.table)
library(fst)
library(ape)           # pylogenetic tree operations
library(ggplot2)
library(BiocManager)   # needed to run the following packages?
library(ggtree)        # plotting phylogenetic trees
library(tidytree)      # plotting phylogenetic trees
library(ggtreeExtra)   # plotting phylogenetic trees
library(ape)           # pairwise distances from a phylogenetic tree
library(dplyr)
library(magrittr)


od <- # output directory
  "../Outputs/GIFT_Phylogeny" %T>%
  dir.create(recursive = T, showWarnings = F)


# Download phylogeny ####

phy <- # phylogeny of vascular plants
  GIFT_phylogeny(clade = "Tracheophyta",
                 GIFT_version = "3.1")

# Problem with hybrid species on the tip labels of the phylo tree
phy$tip.label[substring(phy$tip.label, 1, 2) == "x_"] <-
  substring(phy$tip.label[substring(phy$tip.label, 1, 2) == "x_"],
            3,
            nchar(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"]))

phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"] <-
  substring(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"],
            3,
            nchar(phy$tip.label[substring(phy$tip.label, 1, 2) == "×_"]))


# Load crops and CWRs ####

cwr <- # crop wild relatives
  read.fst("../Outputs/GIFT_Harmonised_Names/CWR_GIFT_fuzzy_Spp_List.fst") %>%
  tibble

crops <- # crop species
  fread("../Outputs/GIFT_Harmonised_Names/Crops_GIFT_fuzzy_Spp_List.csv") %>%
  tibble

conflict <- # species listed both as crops and CWRs
  cwr[cwr$work_ID %in% crops$work_ID,] %>%
  arrange(work_ID) %>%
  select(work_species.y,
         work_genus,
         work_author,
         work_ID) %>%
  rename(work_species = work_species.y) %T>%
  fwrite(file.path(od, "Spp_both_crop_and_CWR.csv"))

# crops %<>% # remove species listed as CWR from the crop list
#   filter(!(work_ID %in% conflict$work_ID))

cwr %<>% # remove species listed as crops from the CWR list
  filter(!(work_ID %in% conflict$work_ID))

cwr_sel <- 
  select(cwr, work_species.y, work_genus, work_ID) %>%
  rename(work_species = work_species.y)

crps_sel <-
  select(crops, harmonised_name, work_genus, work_ID) %>%
  rename(work_species = harmonised_name)

sp <- # list of species of interest
  bind_rows(cwr_sel,
            crps_sel) %>%
  mutate(is_crop = c(rep(F, nrow(cwr)), rep(T, nrow(crops)))) %>%
  filter(!duplicated(.[["work_ID"]])) # remove duplicates (same work_ID)

# ! takes some time ! #
sp_fam <- # family of each species
  GIFT_taxgroup(work_ID = sp$work_ID,
                taxon_lvl = "family",
                GIFT_version = "3.1")

sp_genus_fam <- # add family
  sp %>%
  mutate(family = sp_fam) %>% 
  mutate(species = gsub("([[:punct:]])|\\s+",
                        "_",
                        work_species))

sp_phy <- # species with philogeny
  sp_genus_fam %>%
  filter(species %in% phy$tip.label)


# > Plot ####

phy_gen <- # keep only crops and CWRs
  ape::keep.tip(phy = phy, # ape:: is needed as same function in tidytree{}
                tip = phy$tip.label[phy$tip.label %in% sp_phy$species])

is_crop <- # labels to colour tree fruits
  left_join(tibble(species = phy_gen$tip.label),
            sp_phy,
            by = "species") %>%
  pull(is_crop)

phy_plot <- # phylogenetic plot
  ggtree(phy_gen,
         layout = "circular",
         color = "grey")  %<+%
  data.frame(is_crop) +
  geom_fruit(geom = geom_tile,
             mapping = aes(fill = is_crop),
             width = 3,
             offset = 0.01) +
  geom_tiplab(size = 1.25,
              offset = 4) +
  theme(legend.text = element_text(size = 5),
        legend.title = element_text(size = 7),
        legend.key.size = unit(4, 'mm'),
        legend.position = "bottom", 
        legend.box.spacing = unit(1, "cm"),
        plot.margin = unit(c(1,1,1,1),"cm"))

phy_plot

ggsave(phy_plot,
       filename = "CRW_Tree_All.png",
       path = od,
       width = 40,
       height = 40,
       units = "cm",
       dpi = 300)


# Nearest crops ####

dm <- # distance matrix
  cophenetic(phy_gen)

cr_phy <- # crops from phylogeny
  sp_phy %>%
  filter(is_crop == T) %>%
  pull(species)

cwr_phy <- # CWRs from phylogeny
  sp_phy %>%
  filter(is_crop == F) %>%
  pull(species)

nc <- # nearest crop
  sapply(seq_along(cwr_phy), function(n){
    
    cr_candidates <- # crop candidates
      dm[cwr_phy[n], cr_phy]
    
    crop_dist <- # genetic distance
      cr_candidates %>%
      min
    
    crop_names <- # crop names (there may be multiple equidistant crops)
      cr_candidates[cr_candidates == crop_dist] %>%
      names
  
    return(sort(crop_names[1])) # return first in alfabetical order
    
  })

fc <- # foreign crops
  cr_phy[!(cr_phy %in% nc)]

sp_phy2 <-
  sp_phy %>%
  filter(!(species %in% fc))






cwr_crop <- # nearest crop to each CWR
  tibble(cwr = c(cwr_phy, gsub("([[:punct:]])|\\s+",
                               "_",
                               conflict$work_species)),
         crop = c(nc, gsub("([[:punct:]])|\\s+",
                           "_",
                           conflict$work_species)))

cwr_crop$crop_common_name <- # add crop's common name
  crops %>%
  filter(!duplicated(.[["harmonised_name"]])) %>% # remove duplicates (same work_ID)
  mutate(species = gsub("([[:punct:]])|\\s+",
                        "_",
                        harmonised_name)) %>%
  left_join(cwr_crop, ., by = join_by(crop == species)) %>%
  pull(common_name)


# > Plot ####

phy_gen2 <- # keep only crops and CWRs
  ape::keep.tip(phy = phy, # ape:: is needed as same function in tidytree{}
                tip = phy$tip.label[phy$tip.label %in% sp_phy2$species])

is_crop2 <- # labels to colour tree fruits
  left_join(tibble(species = phy_gen2$tip.label),
            sp_phy2,
            by = "species") %>%
  pull(is_crop)

phy_plot2 <- # phylogenetic plot
  ggtree(phy_gen2,
         layout = "circular",
         color = "grey")  %<+%
  data.frame(is_crop2) +
  geom_fruit(geom = geom_tile,
             mapping = aes(fill = is_crop2),
             width = 3,
             offset = 0.01) +
  geom_tiplab(size = 1.25,
              offset = 4) +
  theme(legend.text = element_text(size = 5),
        legend.title = element_text(size = 7),
        legend.key.size = unit(4, 'mm'),
        legend.position = "bottom", 
        legend.box.spacing = unit(1, "cm"),
        plot.margin = unit(c(1,1,1,1),"cm"))

phy_plot2

ggsave(phy_plot2,
       filename = "CRW_Tree_Next_Of_Keen.png",
       path = od,
       width = 40,
       height = 40,
       units = "cm",
       dpi = 300)
